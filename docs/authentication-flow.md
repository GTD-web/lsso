# 로그인 인증 절차 문서

## 개요

LSSO (Legacy Single Sign-On) 시스템의 로그인 인증 절차에 대한 문서입니다. 본 시스템은 OAuth 2.0 grant type을 기반으로 한 토큰 기반 인증을 제공합니다.

## 인증 방식

### 지원하는 Grant Type

-   **password**: 이메일/비밀번호 기반 인증
-   **refresh_token**: 리프레시 토큰 기반 갱신

### 인증 절차

#### 1. 패스워드 기반 인증 절차

1. **사용자 검증**: 이메일로 직원 정보 조회 및 상태 확인
2. **비밀번호 검증**: bcrypt를 사용한 해시 비교
3. **조직 정보 조회**: 부서, 직책, 직급 정보 병렬 조회
4. **시스템 권한 조회**: 시스템별 역할 목록 조회 및 그룹핑
5. **토큰 생성**: JWT 액세스 토큰(1일) 및 리프레시 토큰(30일) 발급

#### 2. 리프레시 토큰 기반 갱신 절차

1. **토큰 검증**: 리프레시 토큰 유효성 및 만료 시간 확인
2. **사용자 확인**: JWT 페이로드에서 사용자 정보 추출
3. **조직 정보 조회**: 최신 부서, 직책, 직급 정보 조회
4. **시스템 권한 조회**: 시스템별 역할 목록 갱신
5. **새 토큰 발급**: 갱신된 액세스 토큰 및 리프레시 토큰 발급

## 시스템 인증 (주석 처리된 기능)

### Basic Auth 시스템 인증 - **현재 비활성화**

```
// 원래 설계: 외부 시스템이 Basic Auth로 먼저 인증 후 사용자 로그인 수행
// @ApiBasicAuth()
// @Headers('Authorization') authHeader?: string
```

**비활성화된 절차:**

1. Basic Auth 헤더 파싱 (clientId:clientSecret)
2. 시스템 조회 및 활성화 상태 확인
3. 클라이언트 시크릿 검증 (bcrypt 비교)

## 토큰 관리 방식

### 토큰 생성 및 저장

-   **JWT 토큰**: HS256 알고리즘 사용
-   **액세스 토큰**: 1일 만료, 실제 API 호출용
-   **리프레시 토큰**: 30일 만료, 토큰 갱신용
-   **데이터베이스 저장**: 토큰 정보 및 직원-토큰 관계 저장

## 보안 메커니즘

### 1. 사용자 인증 보안

-   **이메일 기반 조회**: 고유 식별자로 사용자 특정
-   **퇴사자 차단**: 상태가 '퇴사'인 경우 로그인 거부
-   **bcrypt 해싱**: 솔트 포함 비밀번호 해시 비교

### 2. 토큰 보안

-   **JWT 서명**: 토큰 무결성 보장
-   **단기 액세스 토큰**: 1일 만료로 노출 위험 최소화
-   **장기 리프레시 토큰**: 30일 만료로 사용자 편의성 제공
-   **만료 토큰 정리**: 자동 정리 기능으로 데이터베이스 최적화

### 3. 상태 검증

-   **토큰 만료 검증**: 모든 토큰 사용 시 만료 시간 확인
-   **사용자 존재 확인**: 토큰 검증 시 사용자 실존 여부 재확인

## 조직 정보 관리

### 부서-직책-직급 조회 방식

1. **직원-부서-직책 관계**: 중간 테이블을 통한 다대다 관계
2. **병렬 조회**: 부서, 직책, 직급 정보를 동시 조회하여 성능 최적화
3. **조직 정보 포함**: 로그인 응답에 현재 조직 정보 포함

### 시스템 역할 관리

-   **시스템별 그룹핑**: 하나의 사용자가 여러 시스템에서 다중 역할 보유 가능
-   **역할 코드 매핑**: 시스템명을 키로 하는 역할 배열 반환
-   **동적 권한**: 로그인 시마다 최신 권한 정보 조회

## 성능 최적화

### 1. 병렬 처리

-   조직 정보(부서/직책/직급) 병렬 조회
-   시스템 역할 조회와 조직 정보 조회 독립 실행

### 2. 데이터베이스 최적화

-   이메일 인덱스를 활용한 빠른 사용자 조회
-   토큰 테이블 인덱스를 통한 효율적인 토큰 검색

### 3. 토큰 관리 최적화

-   만료된 토큰 자동 정리로 데이터베이스 크기 관리
-   중복 세션 허용으로 사용자 편의성 향상

## 에러 처리

### 주요 에러 케이스

-   **400 Bad Request**: 잘못된 grant_type, 필수 파라미터 누락
-   **401 Unauthorized**: 잘못된 인증 정보, 퇴사자, 만료된 토큰
-   **404 Not Found**: 존재하지 않는 사용자 또는 토큰

### 보안 고려사항

-   에러 메시지에서 민감한 정보 노출 방지
-   실패 로그 기록으로 보안 모니터링 지원

---

**작성일**: 2024년 12월  
**버전**: 1.1  
**작성자**: LSSO 개발팀
